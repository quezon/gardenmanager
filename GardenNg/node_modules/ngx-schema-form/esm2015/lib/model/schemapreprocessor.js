/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { isBlank } from './utils';
/**
 * @param {?} message
 * @param {?} path
 * @return {?}
 */
function formatMessage(message, path) {
    return `Parsing error on ${path}: ${message}`;
}
/**
 * @param {?} message
 * @param {?} path
 * @return {?}
 */
function schemaError(message, path) {
    /** @type {?} */
    let mesg = formatMessage(message, path);
    throw new Error(mesg);
}
/**
 * @param {?} message
 * @param {?} path
 * @return {?}
 */
function schemaWarning(message, path) {
    /** @type {?} */
    let mesg = formatMessage(message, path);
    throw new Error(mesg);
}
export class SchemaPreprocessor {
    /**
     * @param {?} jsonSchema
     * @param {?=} path
     * @return {?}
     */
    static preprocess(jsonSchema, path = '/') {
        jsonSchema = jsonSchema || {};
        SchemaPreprocessor.normalizeExtensions(jsonSchema);
        if (jsonSchema.type === 'object') {
            SchemaPreprocessor.checkProperties(jsonSchema, path);
            SchemaPreprocessor.checkAndCreateFieldsets(jsonSchema, path);
        }
        else if (jsonSchema.type === 'array') {
            SchemaPreprocessor.checkItems(jsonSchema, path);
        }
        SchemaPreprocessor.normalizeWidget(jsonSchema);
        SchemaPreprocessor.recursiveCheck(jsonSchema, path);
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @param {?} path
     * @return {?}
     */
    static checkProperties(jsonSchema, path) {
        if (isBlank(jsonSchema.properties)) {
            jsonSchema.properties = {};
            schemaWarning('Provided json schema does not contain a \'properties\' entry. Output schema will be empty', path);
        }
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @param {?} path
     * @return {?}
     */
    static checkAndCreateFieldsets(jsonSchema, path) {
        if (jsonSchema.fieldsets === undefined) {
            if (jsonSchema.order !== undefined) {
                SchemaPreprocessor.replaceOrderByFieldsets(jsonSchema);
            }
            else {
                SchemaPreprocessor.createFieldsets(jsonSchema);
            }
        }
        SchemaPreprocessor.checkFieldsUsage(jsonSchema, path);
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @param {?} path
     * @return {?}
     */
    static checkFieldsUsage(jsonSchema, path) {
        /** @type {?} */
        let fieldsId = Object.keys(jsonSchema.properties);
        /** @type {?} */
        let usedFields = {};
        for (let fieldset of jsonSchema.fieldsets) {
            for (let fieldId of fieldset.fields) {
                if (usedFields[fieldId] === undefined) {
                    usedFields[fieldId] = [];
                }
                usedFields[fieldId].push(fieldset.id);
            }
        }
        for (const fieldId of fieldsId) {
            /** @type {?} */
            const isRequired = jsonSchema.required && jsonSchema.required.indexOf(fieldId) > -1;
            if (isRequired && jsonSchema.properties[fieldId]) {
                jsonSchema.properties[fieldId].isRequired = true;
            }
            if (usedFields.hasOwnProperty(fieldId)) {
                if (usedFields[fieldId].length > 1) {
                    schemaError(`${fieldId} is referenced by more than one fieldset: ${usedFields[fieldId]}`, path);
                }
                delete usedFields[fieldId];
            }
            else if (isRequired) {
                schemaError(`${fieldId} is a required field but it is not referenced as part of a 'order' or a 'fieldset' property`, path);
            }
            else {
                delete jsonSchema[fieldId];
                schemaWarning(`Removing unreferenced field ${fieldId}`, path);
            }
        }
        for (let remainingfieldsId in usedFields) {
            if (usedFields.hasOwnProperty(remainingfieldsId)) {
                schemaWarning(`Referencing non-existent field ${remainingfieldsId} in one or more fieldsets`, path);
            }
        }
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @return {?}
     */
    static createFieldsets(jsonSchema) {
        jsonSchema.order = Object.keys(jsonSchema.properties);
        SchemaPreprocessor.replaceOrderByFieldsets(jsonSchema);
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @return {?}
     */
    static replaceOrderByFieldsets(jsonSchema) {
        jsonSchema.fieldsets = [{
                id: 'fieldset-default',
                title: jsonSchema.title || '',
                description: jsonSchema.description || '',
                name: jsonSchema.name || '',
                fields: jsonSchema.order
            }];
        delete jsonSchema.order;
    }
    /**
     * @private
     * @param {?} fieldSchema
     * @return {?}
     */
    static normalizeWidget(fieldSchema) {
        /** @type {?} */
        let widget = fieldSchema.widget;
        if (widget === undefined) {
            widget = { 'id': fieldSchema.type };
        }
        else if (typeof widget === 'string') {
            widget = { 'id': widget };
        }
        fieldSchema.widget = widget;
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @param {?} path
     * @return {?}
     */
    static checkItems(jsonSchema, path) {
        if (jsonSchema.items === undefined) {
            schemaError('No \'items\' property in array', path);
        }
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @param {?} path
     * @return {?}
     */
    static recursiveCheck(jsonSchema, path) {
        if (jsonSchema.type === 'object') {
            for (let fieldId in jsonSchema.properties) {
                if (jsonSchema.properties.hasOwnProperty(fieldId)) {
                    /** @type {?} */
                    let fieldSchema = jsonSchema.properties[fieldId];
                    SchemaPreprocessor.preprocess(fieldSchema, path + fieldId + '/');
                }
            }
            if (jsonSchema.hasOwnProperty('definitions')) {
                for (let fieldId in jsonSchema.definitions) {
                    if (jsonSchema.definitions.hasOwnProperty(fieldId)) {
                        /** @type {?} */
                        let fieldSchema = jsonSchema.definitions[fieldId];
                        SchemaPreprocessor.removeRecursiveRefProperties(fieldSchema, `#/definitions/${fieldId}`);
                        SchemaPreprocessor.preprocess(fieldSchema, path + fieldId + '/');
                    }
                }
            }
        }
        else if (jsonSchema.type === 'array') {
            SchemaPreprocessor.preprocess(jsonSchema.items, path + '*/');
        }
    }
    /**
     * @private
     * @param {?} jsonSchema
     * @param {?} definitionPath
     * @return {?}
     */
    static removeRecursiveRefProperties(jsonSchema, definitionPath) {
        // to avoid infinite loop
        if (jsonSchema.type === 'object') {
            for (let fieldId in jsonSchema.properties) {
                if (jsonSchema.properties.hasOwnProperty(fieldId)) {
                    if (jsonSchema.properties[fieldId].$ref
                        && jsonSchema.properties[fieldId].$ref === definitionPath) {
                        delete jsonSchema.properties[fieldId];
                    }
                    else if (jsonSchema.properties[fieldId].type === 'object') {
                        SchemaPreprocessor.removeRecursiveRefProperties(jsonSchema.properties[fieldId], definitionPath);
                    }
                }
            }
        }
    }
    /**
     * Enables alias names for JSON schema extensions.
     *
     * Copies the value of each alias JSON schema property
     * to the JSON schema property of ngx-schema-form.
     *
     * @private
     * @param {?} schema JSON schema to enable alias names.
     * @return {?}
     */
    static normalizeExtensions(schema) {
        /** @type {?} */
        const extensions = [
            { name: "fieldsets", regex: /^x-?field-?sets$/i },
            { name: "widget", regex: /^x-?widget$/i },
            { name: "visibleIf", regex: /^x-?visible-?if$/i }
        ];
        /** @type {?} */
        const keys = Object.keys(schema);
        for (let i = 0; i < keys.length; ++i) {
            /** @type {?} */
            let k = keys[i];
            /** @type {?} */
            let e = extensions.find((/**
             * @param {?} e
             * @return {?}
             */
            e => !!k.match(e.regex)));
            if (e) {
                /** @type {?} */
                let v = schema[k];
                /** @type {?} */
                let copy = JSON.parse(JSON.stringify(v));
                schema[e.name] = copy;
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZW1hcHJlcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXNjaGVtYS1mb3JtLyIsInNvdXJjZXMiOlsibGliL21vZGVsL3NjaGVtYXByZXByb2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLFNBQVMsQ0FBQzs7Ozs7O0FBRWhDLFNBQVMsYUFBYSxDQUFDLE9BQU8sRUFBRSxJQUFJO0lBQ2xDLE9BQU8sb0JBQW9CLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztBQUNoRCxDQUFDOzs7Ozs7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUFPLEVBQUUsSUFBSTs7UUFDNUIsSUFBSSxHQUFHLGFBQWEsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDO0lBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDeEIsQ0FBQzs7Ozs7O0FBRUQsU0FBUyxhQUFhLENBQUMsT0FBTyxFQUFFLElBQUk7O1FBQzlCLElBQUksR0FBRyxhQUFhLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztJQUN2QyxNQUFNLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxNQUFNLE9BQU8sa0JBQWtCOzs7Ozs7SUFFN0IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFlLEVBQUUsSUFBSSxHQUFHLEdBQUc7UUFDM0MsVUFBVSxHQUFHLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDOUIsa0JBQWtCLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbkQsSUFBSSxVQUFVLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUNoQyxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3JELGtCQUFrQixDQUFDLHVCQUF1QixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUM5RDthQUFNLElBQUksVUFBVSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUU7WUFDdEMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUNqRDtRQUNELGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMvQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RELENBQUM7Ozs7Ozs7SUFFTyxNQUFNLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxJQUFZO1FBQ3JELElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNsQyxVQUFVLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztZQUMzQixhQUFhLENBQUMsMkZBQTJGLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDbEg7SUFDSCxDQUFDOzs7Ozs7O0lBRU8sTUFBTSxDQUFDLHVCQUF1QixDQUFDLFVBQWUsRUFBRSxJQUFZO1FBQ2xFLElBQUksVUFBVSxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUU7WUFDdEMsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRTtnQkFDbEMsa0JBQWtCLENBQUMsdUJBQXVCLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDeEQ7aUJBQU07Z0JBQ0wsa0JBQWtCLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQ2hEO1NBQ0Y7UUFDRCxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEQsQ0FBQzs7Ozs7OztJQUVPLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsSUFBWTs7WUFDbEQsUUFBUSxHQUFhLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQzs7WUFDdkQsVUFBVSxHQUFHLEVBQUU7UUFDbkIsS0FBSyxJQUFJLFFBQVEsSUFBSSxVQUFVLENBQUMsU0FBUyxFQUFFO1lBQ3pDLEtBQUssSUFBSSxPQUFPLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTtnQkFDbkMsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssU0FBUyxFQUFFO29CQUNyQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO2lCQUMxQjtnQkFDRCxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUN2QztTQUNGO1FBRUQsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7O2tCQUN4QixVQUFVLEdBQUcsVUFBVSxDQUFDLFFBQVEsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkYsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDaEQsVUFBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO2FBQ2xEO1lBQ0QsSUFBSSxVQUFVLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUN0QyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNsQyxXQUFXLENBQUMsR0FBRyxPQUFPLDZDQUE2QyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztpQkFDakc7Z0JBQ0QsT0FBTyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDNUI7aUJBQU0sSUFBSSxVQUFVLEVBQUU7Z0JBQ3JCLFdBQVcsQ0FBQyxHQUFHLE9BQU8sNkZBQTZGLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDNUg7aUJBQU07Z0JBQ0wsT0FBTyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzNCLGFBQWEsQ0FBQywrQkFBK0IsT0FBTyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDL0Q7U0FDRjtRQUVELEtBQUssSUFBSSxpQkFBaUIsSUFBSSxVQUFVLEVBQUU7WUFDeEMsSUFBSSxVQUFVLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLEVBQUU7Z0JBQ2hELGFBQWEsQ0FBQyxrQ0FBa0MsaUJBQWlCLDJCQUEyQixFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ3JHO1NBQ0Y7SUFDSCxDQUFDOzs7Ozs7SUFFTyxNQUFNLENBQUMsZUFBZSxDQUFDLFVBQVU7UUFDdkMsVUFBVSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0RCxrQkFBa0IsQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN6RCxDQUFDOzs7Ozs7SUFFTyxNQUFNLENBQUMsdUJBQXVCLENBQUMsVUFBVTtRQUMvQyxVQUFVLENBQUMsU0FBUyxHQUFHLENBQUM7Z0JBQ3RCLEVBQUUsRUFBRSxrQkFBa0I7Z0JBQ3RCLEtBQUssRUFBRSxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7Z0JBQzdCLFdBQVcsRUFBRSxVQUFVLENBQUMsV0FBVyxJQUFJLEVBQUU7Z0JBQ3pDLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSSxJQUFJLEVBQUU7Z0JBQzNCLE1BQU0sRUFBRSxVQUFVLENBQUMsS0FBSzthQUN6QixDQUFDLENBQUM7UUFDSCxPQUFPLFVBQVUsQ0FBQyxLQUFLLENBQUM7SUFDMUIsQ0FBQzs7Ozs7O0lBRU8sTUFBTSxDQUFDLGVBQWUsQ0FBQyxXQUFnQjs7WUFDekMsTUFBTSxHQUFHLFdBQVcsQ0FBQyxNQUFNO1FBQy9CLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtZQUN4QixNQUFNLEdBQUcsRUFBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLElBQUksRUFBQyxDQUFDO1NBQ25DO2FBQU0sSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDckMsTUFBTSxHQUFHLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBQyxDQUFDO1NBQ3pCO1FBQ0QsV0FBVyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDOUIsQ0FBQzs7Ozs7OztJQUVPLE1BQU0sQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLElBQUk7UUFDeEMsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUNsQyxXQUFXLENBQUMsZ0NBQWdDLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDckQ7SUFDSCxDQUFDOzs7Ozs7O0lBRU8sTUFBTSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsSUFBWTtRQUNwRCxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ2hDLEtBQUssSUFBSSxPQUFPLElBQUksVUFBVSxDQUFDLFVBQVUsRUFBRTtnQkFDekMsSUFBSSxVQUFVLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFBRTs7d0JBQzdDLFdBQVcsR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQztvQkFDaEQsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxJQUFJLEdBQUcsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDO2lCQUNsRTthQUNGO1lBQ0QsSUFBSSxVQUFVLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxFQUFFO2dCQUM1QyxLQUFLLElBQUksT0FBTyxJQUFJLFVBQVUsQ0FBQyxXQUFXLEVBQUU7b0JBQzFDLElBQUksVUFBVSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEVBQUU7OzRCQUM5QyxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUM7d0JBQ2pELGtCQUFrQixDQUFDLDRCQUE0QixDQUFDLFdBQVcsRUFBRSxpQkFBaUIsT0FBTyxFQUFFLENBQUMsQ0FBQzt3QkFDekYsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxJQUFJLEdBQUcsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDO3FCQUNsRTtpQkFDRjthQUNGO1NBQ0Y7YUFBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFO1lBQ3RDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQztTQUM5RDtJQUNILENBQUM7Ozs7Ozs7SUFFTyxNQUFNLENBQUMsNEJBQTRCLENBQUMsVUFBVSxFQUFFLGNBQWM7UUFDcEUseUJBQXlCO1FBQ3pCLElBQUksVUFBVSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDaEMsS0FBSyxJQUFJLE9BQU8sSUFBSSxVQUFVLENBQUMsVUFBVSxFQUFFO2dCQUN6QyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxFQUFFO29CQUNqRCxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSTsyQkFDbEMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEtBQUssY0FBYyxFQUFFO3dCQUMzRCxPQUFPLFVBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7cUJBQ3ZDO3lCQUFNLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO3dCQUMzRCxrQkFBa0IsQ0FBQyw0QkFBNEIsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFLGNBQWMsQ0FBQyxDQUFDO3FCQUNqRztpQkFDRjthQUNGO1NBQ0Y7SUFDSCxDQUFDOzs7Ozs7Ozs7OztJQVVPLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxNQUFXOztjQUN0QyxVQUFVLEdBQUc7WUFDZixFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLG1CQUFtQixFQUFFO1lBQ2pELEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBSyxLQUFLLEVBQUUsY0FBYyxFQUFFO1lBQzVDLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUU7U0FDcEQ7O2NBQ0ssSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ2hDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFOztnQkFDaEMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7O2dCQUNYLENBQUMsR0FBRyxVQUFVLENBQUMsSUFBSTs7OztZQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFDO1lBQ2hELElBQUksQ0FBQyxFQUFFOztvQkFDRCxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQzs7b0JBQ2IsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDeEMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDdkI7U0FDRjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7aXNCbGFua30gZnJvbSAnLi91dGlscyc7XG5cbmZ1bmN0aW9uIGZvcm1hdE1lc3NhZ2UobWVzc2FnZSwgcGF0aCkge1xuICByZXR1cm4gYFBhcnNpbmcgZXJyb3Igb24gJHtwYXRofTogJHttZXNzYWdlfWA7XG59XG5cbmZ1bmN0aW9uIHNjaGVtYUVycm9yKG1lc3NhZ2UsIHBhdGgpOiB2b2lkIHtcbiAgbGV0IG1lc2cgPSBmb3JtYXRNZXNzYWdlKG1lc3NhZ2UsIHBhdGgpO1xuICB0aHJvdyBuZXcgRXJyb3IobWVzZyk7XG59XG5cbmZ1bmN0aW9uIHNjaGVtYVdhcm5pbmcobWVzc2FnZSwgcGF0aCk6IHZvaWQge1xuICBsZXQgbWVzZyA9IGZvcm1hdE1lc3NhZ2UobWVzc2FnZSwgcGF0aCk7XG4gIHRocm93IG5ldyBFcnJvcihtZXNnKTtcbn1cblxuZXhwb3J0IGNsYXNzIFNjaGVtYVByZXByb2Nlc3NvciB7XG5cbiAgc3RhdGljIHByZXByb2Nlc3MoanNvblNjaGVtYTogYW55LCBwYXRoID0gJy8nKTogYW55IHtcbiAgICBqc29uU2NoZW1hID0ganNvblNjaGVtYSB8fCB7fTtcbiAgICBTY2hlbWFQcmVwcm9jZXNzb3Iubm9ybWFsaXplRXh0ZW5zaW9ucyhqc29uU2NoZW1hKTtcbiAgICBpZiAoanNvblNjaGVtYS50eXBlID09PSAnb2JqZWN0Jykge1xuICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLmNoZWNrUHJvcGVydGllcyhqc29uU2NoZW1hLCBwYXRoKTtcbiAgICAgIFNjaGVtYVByZXByb2Nlc3Nvci5jaGVja0FuZENyZWF0ZUZpZWxkc2V0cyhqc29uU2NoZW1hLCBwYXRoKTtcbiAgICB9IGVsc2UgaWYgKGpzb25TY2hlbWEudHlwZSA9PT0gJ2FycmF5Jykge1xuICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLmNoZWNrSXRlbXMoanNvblNjaGVtYSwgcGF0aCk7XG4gICAgfVxuICAgIFNjaGVtYVByZXByb2Nlc3Nvci5ub3JtYWxpemVXaWRnZXQoanNvblNjaGVtYSk7XG4gICAgU2NoZW1hUHJlcHJvY2Vzc29yLnJlY3Vyc2l2ZUNoZWNrKGpzb25TY2hlbWEsIHBhdGgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY2hlY2tQcm9wZXJ0aWVzKGpzb25TY2hlbWEsIHBhdGg6IHN0cmluZykge1xuICAgIGlmIChpc0JsYW5rKGpzb25TY2hlbWEucHJvcGVydGllcykpIHtcbiAgICAgIGpzb25TY2hlbWEucHJvcGVydGllcyA9IHt9O1xuICAgICAgc2NoZW1hV2FybmluZygnUHJvdmlkZWQganNvbiBzY2hlbWEgZG9lcyBub3QgY29udGFpbiBhIFxcJ3Byb3BlcnRpZXNcXCcgZW50cnkuIE91dHB1dCBzY2hlbWEgd2lsbCBiZSBlbXB0eScsIHBhdGgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGNoZWNrQW5kQ3JlYXRlRmllbGRzZXRzKGpzb25TY2hlbWE6IGFueSwgcGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKGpzb25TY2hlbWEuZmllbGRzZXRzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChqc29uU2NoZW1hLm9yZGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLnJlcGxhY2VPcmRlckJ5RmllbGRzZXRzKGpzb25TY2hlbWEpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLmNyZWF0ZUZpZWxkc2V0cyhqc29uU2NoZW1hKTtcbiAgICAgIH1cbiAgICB9XG4gICAgU2NoZW1hUHJlcHJvY2Vzc29yLmNoZWNrRmllbGRzVXNhZ2UoanNvblNjaGVtYSwgcGF0aCk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBjaGVja0ZpZWxkc1VzYWdlKGpzb25TY2hlbWEsIHBhdGg6IHN0cmluZykge1xuICAgIGxldCBmaWVsZHNJZDogc3RyaW5nW10gPSBPYmplY3Qua2V5cyhqc29uU2NoZW1hLnByb3BlcnRpZXMpO1xuICAgIGxldCB1c2VkRmllbGRzID0ge307XG4gICAgZm9yIChsZXQgZmllbGRzZXQgb2YganNvblNjaGVtYS5maWVsZHNldHMpIHtcbiAgICAgIGZvciAobGV0IGZpZWxkSWQgb2YgZmllbGRzZXQuZmllbGRzKSB7XG4gICAgICAgIGlmICh1c2VkRmllbGRzW2ZpZWxkSWRdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB1c2VkRmllbGRzW2ZpZWxkSWRdID0gW107XG4gICAgICAgIH1cbiAgICAgICAgdXNlZEZpZWxkc1tmaWVsZElkXS5wdXNoKGZpZWxkc2V0LmlkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGZpZWxkSWQgb2YgZmllbGRzSWQpIHtcbiAgICAgIGNvbnN0IGlzUmVxdWlyZWQgPSBqc29uU2NoZW1hLnJlcXVpcmVkICYmIGpzb25TY2hlbWEucmVxdWlyZWQuaW5kZXhPZihmaWVsZElkKSA+IC0xO1xuICAgICAgaWYgKGlzUmVxdWlyZWQgJiYganNvblNjaGVtYS5wcm9wZXJ0aWVzW2ZpZWxkSWRdKSB7XG4gICAgICAgIGpzb25TY2hlbWEucHJvcGVydGllc1tmaWVsZElkXS5pc1JlcXVpcmVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmICh1c2VkRmllbGRzLmhhc093blByb3BlcnR5KGZpZWxkSWQpKSB7XG4gICAgICAgIGlmICh1c2VkRmllbGRzW2ZpZWxkSWRdLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICBzY2hlbWFFcnJvcihgJHtmaWVsZElkfSBpcyByZWZlcmVuY2VkIGJ5IG1vcmUgdGhhbiBvbmUgZmllbGRzZXQ6ICR7dXNlZEZpZWxkc1tmaWVsZElkXX1gLCBwYXRoKTtcbiAgICAgICAgfVxuICAgICAgICBkZWxldGUgdXNlZEZpZWxkc1tmaWVsZElkXTtcbiAgICAgIH0gZWxzZSBpZiAoaXNSZXF1aXJlZCkge1xuICAgICAgICBzY2hlbWFFcnJvcihgJHtmaWVsZElkfSBpcyBhIHJlcXVpcmVkIGZpZWxkIGJ1dCBpdCBpcyBub3QgcmVmZXJlbmNlZCBhcyBwYXJ0IG9mIGEgJ29yZGVyJyBvciBhICdmaWVsZHNldCcgcHJvcGVydHlgLCBwYXRoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlbGV0ZSBqc29uU2NoZW1hW2ZpZWxkSWRdO1xuICAgICAgICBzY2hlbWFXYXJuaW5nKGBSZW1vdmluZyB1bnJlZmVyZW5jZWQgZmllbGQgJHtmaWVsZElkfWAsIHBhdGgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAobGV0IHJlbWFpbmluZ2ZpZWxkc0lkIGluIHVzZWRGaWVsZHMpIHtcbiAgICAgIGlmICh1c2VkRmllbGRzLmhhc093blByb3BlcnR5KHJlbWFpbmluZ2ZpZWxkc0lkKSkge1xuICAgICAgICBzY2hlbWFXYXJuaW5nKGBSZWZlcmVuY2luZyBub24tZXhpc3RlbnQgZmllbGQgJHtyZW1haW5pbmdmaWVsZHNJZH0gaW4gb25lIG9yIG1vcmUgZmllbGRzZXRzYCwgcGF0aCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlRmllbGRzZXRzKGpzb25TY2hlbWEpIHtcbiAgICBqc29uU2NoZW1hLm9yZGVyID0gT2JqZWN0LmtleXMoanNvblNjaGVtYS5wcm9wZXJ0aWVzKTtcbiAgICBTY2hlbWFQcmVwcm9jZXNzb3IucmVwbGFjZU9yZGVyQnlGaWVsZHNldHMoanNvblNjaGVtYSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyByZXBsYWNlT3JkZXJCeUZpZWxkc2V0cyhqc29uU2NoZW1hKSB7XG4gICAganNvblNjaGVtYS5maWVsZHNldHMgPSBbe1xuICAgICAgaWQ6ICdmaWVsZHNldC1kZWZhdWx0JyxcbiAgICAgIHRpdGxlOiBqc29uU2NoZW1hLnRpdGxlIHx8ICcnLFxuICAgICAgZGVzY3JpcHRpb246IGpzb25TY2hlbWEuZGVzY3JpcHRpb24gfHwgJycsXG4gICAgICBuYW1lOiBqc29uU2NoZW1hLm5hbWUgfHwgJycsXG4gICAgICBmaWVsZHM6IGpzb25TY2hlbWEub3JkZXJcbiAgICB9XTtcbiAgICBkZWxldGUganNvblNjaGVtYS5vcmRlcjtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIG5vcm1hbGl6ZVdpZGdldChmaWVsZFNjaGVtYTogYW55KSB7XG4gICAgbGV0IHdpZGdldCA9IGZpZWxkU2NoZW1hLndpZGdldDtcbiAgICBpZiAod2lkZ2V0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHdpZGdldCA9IHsnaWQnOiBmaWVsZFNjaGVtYS50eXBlfTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB3aWRnZXQgPT09ICdzdHJpbmcnKSB7XG4gICAgICB3aWRnZXQgPSB7J2lkJzogd2lkZ2V0fTtcbiAgICB9XG4gICAgZmllbGRTY2hlbWEud2lkZ2V0ID0gd2lkZ2V0O1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY2hlY2tJdGVtcyhqc29uU2NoZW1hLCBwYXRoKSB7XG4gICAgaWYgKGpzb25TY2hlbWEuaXRlbXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgc2NoZW1hRXJyb3IoJ05vIFxcJ2l0ZW1zXFwnIHByb3BlcnR5IGluIGFycmF5JywgcGF0aCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcmVjdXJzaXZlQ2hlY2soanNvblNjaGVtYSwgcGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKGpzb25TY2hlbWEudHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGZvciAobGV0IGZpZWxkSWQgaW4ganNvblNjaGVtYS5wcm9wZXJ0aWVzKSB7XG4gICAgICAgIGlmIChqc29uU2NoZW1hLnByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoZmllbGRJZCkpIHtcbiAgICAgICAgICBsZXQgZmllbGRTY2hlbWEgPSBqc29uU2NoZW1hLnByb3BlcnRpZXNbZmllbGRJZF07XG4gICAgICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLnByZXByb2Nlc3MoZmllbGRTY2hlbWEsIHBhdGggKyBmaWVsZElkICsgJy8nKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGpzb25TY2hlbWEuaGFzT3duUHJvcGVydHkoJ2RlZmluaXRpb25zJykpIHtcbiAgICAgICAgZm9yIChsZXQgZmllbGRJZCBpbiBqc29uU2NoZW1hLmRlZmluaXRpb25zKSB7XG4gICAgICAgICAgaWYgKGpzb25TY2hlbWEuZGVmaW5pdGlvbnMuaGFzT3duUHJvcGVydHkoZmllbGRJZCkpIHtcbiAgICAgICAgICAgIGxldCBmaWVsZFNjaGVtYSA9IGpzb25TY2hlbWEuZGVmaW5pdGlvbnNbZmllbGRJZF07XG4gICAgICAgICAgICBTY2hlbWFQcmVwcm9jZXNzb3IucmVtb3ZlUmVjdXJzaXZlUmVmUHJvcGVydGllcyhmaWVsZFNjaGVtYSwgYCMvZGVmaW5pdGlvbnMvJHtmaWVsZElkfWApO1xuICAgICAgICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLnByZXByb2Nlc3MoZmllbGRTY2hlbWEsIHBhdGggKyBmaWVsZElkICsgJy8nKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGpzb25TY2hlbWEudHlwZSA9PT0gJ2FycmF5Jykge1xuICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLnByZXByb2Nlc3MoanNvblNjaGVtYS5pdGVtcywgcGF0aCArICcqLycpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHJlbW92ZVJlY3Vyc2l2ZVJlZlByb3BlcnRpZXMoanNvblNjaGVtYSwgZGVmaW5pdGlvblBhdGgpIHtcbiAgICAvLyB0byBhdm9pZCBpbmZpbml0ZSBsb29wXG4gICAgaWYgKGpzb25TY2hlbWEudHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGZvciAobGV0IGZpZWxkSWQgaW4ganNvblNjaGVtYS5wcm9wZXJ0aWVzKSB7XG4gICAgICAgIGlmIChqc29uU2NoZW1hLnByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoZmllbGRJZCkpIHtcbiAgICAgICAgICBpZiAoanNvblNjaGVtYS5wcm9wZXJ0aWVzW2ZpZWxkSWRdLiRyZWZcbiAgICAgICAgICAgICYmIGpzb25TY2hlbWEucHJvcGVydGllc1tmaWVsZElkXS4kcmVmID09PSBkZWZpbml0aW9uUGF0aCkge1xuICAgICAgICAgICAgZGVsZXRlIGpzb25TY2hlbWEucHJvcGVydGllc1tmaWVsZElkXTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGpzb25TY2hlbWEucHJvcGVydGllc1tmaWVsZElkXS50eXBlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgU2NoZW1hUHJlcHJvY2Vzc29yLnJlbW92ZVJlY3Vyc2l2ZVJlZlByb3BlcnRpZXMoanNvblNjaGVtYS5wcm9wZXJ0aWVzW2ZpZWxkSWRdLCBkZWZpbml0aW9uUGF0aCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIFxuICAvKipcbiAgICogRW5hYmxlcyBhbGlhcyBuYW1lcyBmb3IgSlNPTiBzY2hlbWEgZXh0ZW5zaW9ucy5cbiAgICpcbiAgICogQ29waWVzIHRoZSB2YWx1ZSBvZiBlYWNoIGFsaWFzIEpTT04gc2NoZW1hIHByb3BlcnR5XG4gICAqIHRvIHRoZSBKU09OIHNjaGVtYSBwcm9wZXJ0eSBvZiBuZ3gtc2NoZW1hLWZvcm0uXG4gICAqXG4gICAqIEBwYXJhbSBzY2hlbWEgSlNPTiBzY2hlbWEgdG8gZW5hYmxlIGFsaWFzIG5hbWVzLlxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgbm9ybWFsaXplRXh0ZW5zaW9ucyhzY2hlbWE6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IGV4dGVuc2lvbnMgPSBbXG4gICAgICAgIHsgbmFtZTogXCJmaWVsZHNldHNcIiwgcmVnZXg6IC9eeC0/ZmllbGQtP3NldHMkL2kgfSxcbiAgICAgICAgeyBuYW1lOiBcIndpZGdldFwiLCAgICByZWdleDogL154LT93aWRnZXQkL2kgfSxcbiAgICAgICAgeyBuYW1lOiBcInZpc2libGVJZlwiLCByZWdleDogL154LT92aXNpYmxlLT9pZiQvaSB9XG4gICAgXTtcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoc2NoZW1hKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHtcbiAgICAgIGxldCBrID0ga2V5c1tpXTtcbiAgICAgIGxldCBlID0gZXh0ZW5zaW9ucy5maW5kKGUgPT4gISFrLm1hdGNoKGUucmVnZXgpKTtcbiAgICAgIGlmIChlKSB7XG4gICAgICAgIGxldCB2ID0gc2NoZW1hW2tdO1xuICAgICAgICBsZXQgY29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodikpO1xuICAgICAgICBzY2hlbWFbZS5uYW1lXSA9IGNvcHk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbiJdfQ==